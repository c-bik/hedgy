% Autogenerated with DRAKON Editor 1.22

-module(elli_machine_flow).
-export([handle_request/1]).
%%
%% Header
%%

-include_lib("elli/include/elli.hrl").
-include("elli_machine.hrl").
-include("elli_machine_internal.hrl").




accept_charset(State) ->
    % item 517
    CheckCharset = get_header(<<"Accept-Charset">>, State, <<"*">>),
    {CharsetsAvailable, S1} = call(charsets_provided, State),
    % item 562
    case CharsetsAvailable =:= no_charset of true -> 
        % item 565
        {true, [], S1}
    ; false ->
        % item 564
        ChosenCharset = 
            elli_machine_util:choose_charset(CharsetsAvailable, CheckCharset),
        % item 524
        case ChosenCharset =:= none of true -> 
            % item 527
            {false, [], S1}
        ; false ->
            % item 534
            S2 = set_resp_chosen_charset(ChosenCharset, S1),
            {true, CharsetsAvailable, S2}
        end
    end
.

accept_content_encoding(State) ->
    % item 537
    CheckEncoding = get_header(<<"Accept-Encoding">>, 
        State, <<"identity;q=1.0,*;q=0.5">>),
    {EncodingsProvided, S1} = call(content_encodings_provided, State),
    ChosenContentEncoding = 
        elli_machine_util:choose_encoding(EncodingsProvided, CheckEncoding),
    % item 538
    case ChosenContentEncoding =:= none of true -> 
        % item 541
        {false, [], State}
    ; false ->
        % item 574
        S2 = case ChosenContentEncoding of
            <<"identity">> -> 
                S1;
            _ ->
                Ex1 = emx:set_resp_header(<<"Content-Encoding">>, 
                    ChosenContentEncoding, exchange(S1)), 
                set_exchange(Ex1, S1)
        end,
        % item 515
        {true, EncodingsProvided, S2}
    end
.

accept_content_type(State) ->
    % item 435
    {ContentTypesProvided, S1} = call(content_types_provided, State),
    AcceptHeader = get_header(<<"Accept">>, State, undefined),
    % item 436
    case AcceptHeader =:= undefined of true -> 
        % item 500
        {Ct, Cf} = hd(ContentTypesProvided),
        S2 = with_exchange(fun(Ex) ->
                Ex1 = emx:set_resp_content_type(Ct, Ex),
                emx:set_resp_content_fun(Cf, Ex1) 
             end, S1),
        {true, ContentTypesProvided, S2}
    ; false ->
        % item 439
        ChosenMediaType = 
            elli_machine_util:select_media_type(ContentTypesProvided, AcceptHeader),
        % item 440
        case ChosenMediaType =:= none of true -> 
            % item 446
            {false, [], S1}
        ; false ->
            % item 535
            {MediaType, Fun} = ChosenMediaType,
            
            S2 = with_exchange(fun(Ex) ->
                    Ex1 = emx:set_resp_content_type(MediaType, Ex),
                    emx:set_resp_content_fun(Fun, Ex1) 
                 end, S1),
            
            {true, ContentTypesProvided, S2}
        end
    end
.

accept_language(State) ->
    % item 459
    Req = request(State),
    AcceptLanguageHeader = 
    	elli_request:get_header(<<"Accept-Language">>, Req),
    % item 460
    case AcceptLanguageHeader =:= undefined of true -> 
        % item 465
        {true, State}
    ; false ->
        % item 462
        {LanguageAvailable, S1} = call(language_available, State),
        % item 463
        case LanguageAvailable of true -> 
            % item 466
            {true, S1}
        ; false ->
            % item 467
            {false, S1}
        end
    end
.

call(Name, State) ->
    % item 616
    Result = {Answer, S1} = elli_machine_controller:call(Name, State),
    case Answer of
        {error, _}=E ->
            throw({not_implemented, E});
        {error, _, _}=E ->
            throw({not_implemented, E});
        {halt, Code}=Halt ->
            throw({Halt, S1}); 
        _ ->
            Result
    end
.

content_negotiation(State) ->
    % item 478
    {ContentTypeAccepted, ContentTypesAvailable, S1} =
         accept_content_type(State),
    % item 479
    case ContentTypeAccepted of true -> 
        % item 484
        {LanguageAccepted, S2} = accept_language(S1),
        % item 485
        case LanguageAccepted of true -> 
            % item 491
            {CharsetAccepted, CharsetsAvailable, S3} = accept_charset(S2),
            % item 492
            case CharsetAccepted of true -> 
                % item 495
                {ContentEncodingAccepted, ContentEncodingsAvailable, S4} = 
                    accept_content_encoding(S3),
                % item 497
                case ContentEncodingAccepted of true -> 
                    % item 536
                    %% Set Content-Type header
                    S5 = with_exchange(fun(Exchange) ->
                            CType = emx:get_resp_content_type(Exchange),
                            CSet = case emx:get_resp_chosen_charset(Exchange) of
                                undefined -> <<"">>;
                                Cs -> <<"; charset=", Cs/binary>>
                            end,
                            emx:set_resp_header(<<"Content-Type">>, 
                            <<CType/binary, CSet/binary>>, Exchange) 
                         end, S4),
                    % item 561
                    V1 = add_variance(ContentTypesAvailable, <<"Accept">>, []),
                    V2 = add_variance(CharsetsAvailable, <<"Accept-Charset">>, V1),
                    V3 = add_variance(ContentEncodingsAvailable, <<"Accept-Encoding">>, V2),
                    {ControllerVariances, S6} = call(variances, S5),
                    Variances = ControllerVariances ++ V3,
                    % item 575
                    case Variances =:= [] of true -> 
                        % item 578
                        {true, S6}
                    ; false ->
                        % item 483
                        S7 = set_resp_header(<<"Vary">>, 
                            elli_machine_util:binary_join(Variances, <<", ">>), S6),
                        {true, S7}
                    end
                ; false ->
                    % item 499
                    {false, S4}
                end
            ; false ->
                % item 494
                {false, S3}
            end
        ; false ->
            % item 488
            {false, S2}
        end
    ; false ->
        % item 482
        {false, S1}
    end
.

delete_flow(State) ->
    % item 377
    State
.

do_request(State) ->
    % item 407
    Req = request(State),
    % item 270
    {Pong, S1} = call(ping, State),
    % item 217
    case Pong =:= pong of true -> 
        % item 271
        {ServiceAvailable, S2} = 
            call(service_available, S1),
        % item 220
        case ServiceAvailable of true -> 
            % item 274
            {KnownMethods, S3} = 
                call(known_methods, S2),
            Method = elli_request:method(request(S3)),
            IsKnownMethod = 
                lists:member(Method, KnownMethods),
            % item 223
            case IsKnownMethod of true -> 
                % item 275
                {UriTooLong, S4} = call(uri_too_long, S3),
                % item 227
                case UriTooLong of true -> 
                    % item 230
                    % Request-URI Too Long
                    respond(414, S4)
                ; false ->
                    % item 276
                    {AllowedMethods, S5} = call(allowed_methods, S4),
                    IsAllowedMethod = 
                        lists:member(Method, AllowedMethods),
                    % item 231
                    case IsAllowedMethod of true -> 
                        % item 277
                        {MalformedRequest, S6} = 
                            call(malformed_request, S5),
                        % item 278
                        case MalformedRequest of true -> 
                            % item 280
                            % Bad Request
                            respond(400, S6)
                        ; false ->
                            % item 281
                            {IsAuthorized, S7} = call(is_authorized, S6),
                            % item 240
                            case IsAuthorized =:= true of true -> 
                                % item 283
                                {Forbidden, S8} = call(forbidden, S7),
                                % item 243
                                case Forbidden of true -> 
                                    % item 246
                                    % Forbidden
                                    respond(403, S7)
                                ; false ->
                                    % item 402
                                    case Method =:= 'OPTIONS' of true -> 
                                        % item 268
                                        options_flow(S8)
                                    ; false ->
                                        % item 489
                                        {ContentAccepted, S9} = content_negotiation(S8),
                                        % item 448
                                        case ContentAccepted of true -> 
                                            % item 2530001
                                            case (Method =:= 'GET') orelse (Method =:= 'HEAD') of true -> 
                                                % item 264
                                                get_flow(S9)
                                            ; false ->
                                                % item 2530003
                                                case Method =:= 'POST' of true -> 
                                                    % item 265
                                                    post_flow(S9)
                                                ; false ->
                                                    % item 2530004
                                                    case Method =:= 'PUT' of true -> 
                                                        % item 266
                                                        put_flow(S9)
                                                    ; false ->
                                                        % item 2530005
                                                        case Method =:= 'DELETE' of true -> 
                                                            []
                                                        ; false ->
                                                            % item 2530006
                                                            throw("Unexpected switch value")
                                                        end,
                                                        % item 267
                                                        delete_flow(S9)
                                                    end
                                                end
                                            end
                                        ; false ->
                                            % item 417
                                            % Not Acceptable
                                            respond(406, S8)
                                        end
                                    end
                                end
                            ; false ->
                                % item 680
                                case is_binary(IsAuthorized) of true -> 
                                    % item 684
                                    Ex = emx:set_resp_header(<<"WWW-Authenticate">>, 
                                        IsAuthorized, exchange(S7)), 
                                    S8 = set_exchange(Ex, S7),
                                    % item 282
                                    respond(401, S7)
                                ; false ->
                                    % item 683
                                    throw({error, no_auth_header})
                                end
                            end
                        end
                    ; false ->
                        % item 250
                        S6 = set_allowed_methods(
                            AllowedMethods, S5),
                        
                        % Method Not Allowed
                        respond(405, S6)
                    end
                end
            ; false ->
                % item 226
                % Not Implemented
                respond(501, S3)
            end
        ; false ->
            % item 219
            % Service Unavailable
            respond(503, S2)
        end
    ; false ->
        % item 273
        % Service Unavailable
        respond(503, S1)
    end
.

exchange(State) ->
    % item 664
    State#machine_flow_state.exchange
.

finalize(State) ->
    % item 296
    HasRespBody = has_resp_body(State),
    % item 171
    case HasRespBody of true -> 
        % item 189
        {MultipleChoices, S1} = call(multiple_choices, State),
        % item 174
        case MultipleChoices of true -> 
            % item 178
            % Multiple Choices
            respond(300, S1)
        ; false ->
            % item 192
            % OK
            respond(200, S1)
        end
    ; false ->
        % item 177
        % No Content
        respond(204, State)
    end
.

get_flow(State) ->
    % item 194
    Req = request(State),
    {ResourceExists, S1} = call(resource_exists, State),
    % item 6
    case ResourceExists of true -> 
        % item 301
        {ETag, S2} = call(generate_etag, S1),
        IfMatchHeader = 
            elli_request:get_header(<<"If-Match">>, Req),
        % item 23
        case IfMatchHeader =:= undefined of true -> 
            % item 290
            {LastModified, S3} = call(last_modified, S2),
            % item 302
            case LastModified =:= undefined of true -> 
                % item 284
                {Expires, S4} = call(expires, S3),
                S5 = set_etag(ETag, S4),
                S6 = set_expires(Expires, S5),
                % item 304
                IfNoneMatch = 
                    elli_request:get_header(<<"If-None-Match">>, Req),
                % item 36
                case IfNoneMatch =:= undefined of true -> 
                    % item 39
                    case IfNoneMatch =:= <<"*">> of true -> 
                        % item 44
                        % Not Modified
                        error(304, S6)
                    ; false ->
                        % item 298
                        ETagMatches = 
                            match_etag(ETag, IfMatchHeader),
                        % item 45
                        case ETagMatches of true -> 
                            % item 44
                            % Not Modified
                            error(304, S6)
                        ; false ->
                            % item 46
                            S7 = set_last_modified(LastModified, S6),
                            
                            Ex = exchange(S7),
                            {Response, S8} = call(emx:get_resp_content_fun(Ex), S7),
                            Ex1 = emx:set_resp_body(Response, Ex),
                            S9 = set_exchange(Ex1, S8),
                            % item 187
                            finalize(S9)
                        end
                    end
                ; false ->
                    % item 46
                    S7 = set_last_modified(LastModified, S6),
                    
                    Ex = exchange(S7),
                    {Response, S8} = call(emx:get_resp_content_fun(Ex), S7),
                    Ex1 = emx:set_resp_body(Response, Ex),
                    S9 = set_exchange(Ex1, S8),
                    % item 187
                    finalize(S9)
                end
            ; false ->
                % item 289
                IfModifiedSince =
                    elli_request:get_header(<<"If-Modified-Since">>, Req),
                % item 33
                case IfModifiedSince =:= undefined of true -> 
                    % item 284
                    {Expires, S4} = call(expires, S3),
                    S5 = set_etag(ETag, S4),
                    S6 = set_expires(Expires, S5),
                    % item 304
                    IfNoneMatch = 
                        elli_request:get_header(<<"If-None-Match">>, Req),
                    % item 36
                    case IfNoneMatch =:= undefined of true -> 
                        % item 39
                        case IfNoneMatch =:= <<"*">> of true -> 
                            % item 44
                            % Not Modified
                            error(304, S6)
                        ; false ->
                            % item 298
                            ETagMatches = 
                                match_etag(ETag, IfMatchHeader),
                            % item 45
                            case ETagMatches of true -> 
                                % item 44
                                % Not Modified
                                error(304, S6)
                            ; false ->
                                % item 46
                                S7 = set_last_modified(LastModified, S6),
                                
                                Ex = exchange(S7),
                                {Response, S8} = call(emx:get_resp_content_fun(Ex), S7),
                                Ex1 = emx:set_resp_body(Response, Ex),
                                S9 = set_exchange(Ex1, S8),
                                % item 187
                                finalize(S9)
                            end
                        end
                    ; false ->
                        % item 46
                        S7 = set_last_modified(LastModified, S6),
                        
                        Ex = exchange(S7),
                        {Response, S8} = call(emx:get_resp_content_fun(Ex), S7),
                        Ex1 = emx:set_resp_body(Response, Ex),
                        S9 = set_exchange(Ex1, S8),
                        % item 187
                        finalize(S9)
                    end
                ; false ->
                    % item 57
                    case LastModified > IfModifiedSince of true -> 
                        % item 371
                        % Precondition Failed
                        error(412, S3)
                    ; false ->
                        % item 284
                        {Expires, S4} = call(expires, S3),
                        S5 = set_etag(ETag, S4),
                        S6 = set_expires(Expires, S5),
                        % item 304
                        IfNoneMatch = 
                            elli_request:get_header(<<"If-None-Match">>, Req),
                        % item 36
                        case IfNoneMatch =:= undefined of true -> 
                            % item 39
                            case IfNoneMatch =:= <<"*">> of true -> 
                                % item 44
                                % Not Modified
                                error(304, S6)
                            ; false ->
                                % item 298
                                ETagMatches = 
                                    match_etag(ETag, IfMatchHeader),
                                % item 45
                                case ETagMatches of true -> 
                                    % item 44
                                    % Not Modified
                                    error(304, S6)
                                ; false ->
                                    % item 46
                                    S7 = set_last_modified(LastModified, S6),
                                    
                                    Ex = exchange(S7),
                                    {Response, S8} = call(emx:get_resp_content_fun(Ex), S7),
                                    Ex1 = emx:set_resp_body(Response, Ex),
                                    S9 = set_exchange(Ex1, S8),
                                    % item 187
                                    finalize(S9)
                                end
                            end
                        ; false ->
                            % item 46
                            S7 = set_last_modified(LastModified, S6),
                            
                            Ex = exchange(S7),
                            {Response, S8} = call(emx:get_resp_content_fun(Ex), S7),
                            Ex1 = emx:set_resp_body(Response, Ex),
                            S9 = set_exchange(Ex1, S8),
                            % item 187
                            finalize(S9)
                        end
                    end
                end
            end
        ; false ->
            % item 26
            case IfMatchHeader =:= <<"*">> of true -> 
                % item 290
                {LastModified, S3} = call(last_modified, S2),
                % item 302
                case LastModified =:= undefined of true -> 
                    % item 284
                    {Expires, S4} = call(expires, S3),
                    S5 = set_etag(ETag, S4),
                    S6 = set_expires(Expires, S5),
                    % item 304
                    IfNoneMatch = 
                        elli_request:get_header(<<"If-None-Match">>, Req),
                    % item 36
                    case IfNoneMatch =:= undefined of true -> 
                        % item 39
                        case IfNoneMatch =:= <<"*">> of true -> 
                            % item 44
                            % Not Modified
                            error(304, S6)
                        ; false ->
                            % item 298
                            ETagMatches = 
                                match_etag(ETag, IfMatchHeader),
                            % item 45
                            case ETagMatches of true -> 
                                % item 44
                                % Not Modified
                                error(304, S6)
                            ; false ->
                                % item 46
                                S7 = set_last_modified(LastModified, S6),
                                
                                Ex = exchange(S7),
                                {Response, S8} = call(emx:get_resp_content_fun(Ex), S7),
                                Ex1 = emx:set_resp_body(Response, Ex),
                                S9 = set_exchange(Ex1, S8),
                                % item 187
                                finalize(S9)
                            end
                        end
                    ; false ->
                        % item 46
                        S7 = set_last_modified(LastModified, S6),
                        
                        Ex = exchange(S7),
                        {Response, S8} = call(emx:get_resp_content_fun(Ex), S7),
                        Ex1 = emx:set_resp_body(Response, Ex),
                        S9 = set_exchange(Ex1, S8),
                        % item 187
                        finalize(S9)
                    end
                ; false ->
                    % item 289
                    IfModifiedSince =
                        elli_request:get_header(<<"If-Modified-Since">>, Req),
                    % item 33
                    case IfModifiedSince =:= undefined of true -> 
                        % item 284
                        {Expires, S4} = call(expires, S3),
                        S5 = set_etag(ETag, S4),
                        S6 = set_expires(Expires, S5),
                        % item 304
                        IfNoneMatch = 
                            elli_request:get_header(<<"If-None-Match">>, Req),
                        % item 36
                        case IfNoneMatch =:= undefined of true -> 
                            % item 39
                            case IfNoneMatch =:= <<"*">> of true -> 
                                % item 44
                                % Not Modified
                                error(304, S6)
                            ; false ->
                                % item 298
                                ETagMatches = 
                                    match_etag(ETag, IfMatchHeader),
                                % item 45
                                case ETagMatches of true -> 
                                    % item 44
                                    % Not Modified
                                    error(304, S6)
                                ; false ->
                                    % item 46
                                    S7 = set_last_modified(LastModified, S6),
                                    
                                    Ex = exchange(S7),
                                    {Response, S8} = call(emx:get_resp_content_fun(Ex), S7),
                                    Ex1 = emx:set_resp_body(Response, Ex),
                                    S9 = set_exchange(Ex1, S8),
                                    % item 187
                                    finalize(S9)
                                end
                            end
                        ; false ->
                            % item 46
                            S7 = set_last_modified(LastModified, S6),
                            
                            Ex = exchange(S7),
                            {Response, S8} = call(emx:get_resp_content_fun(Ex), S7),
                            Ex1 = emx:set_resp_body(Response, Ex),
                            S9 = set_exchange(Ex1, S8),
                            % item 187
                            finalize(S9)
                        end
                    ; false ->
                        % item 57
                        case LastModified > IfModifiedSince of true -> 
                            % item 371
                            % Precondition Failed
                            error(412, S3)
                        ; false ->
                            % item 284
                            {Expires, S4} = call(expires, S3),
                            S5 = set_etag(ETag, S4),
                            S6 = set_expires(Expires, S5),
                            % item 304
                            IfNoneMatch = 
                                elli_request:get_header(<<"If-None-Match">>, Req),
                            % item 36
                            case IfNoneMatch =:= undefined of true -> 
                                % item 39
                                case IfNoneMatch =:= <<"*">> of true -> 
                                    % item 44
                                    % Not Modified
                                    error(304, S6)
                                ; false ->
                                    % item 298
                                    ETagMatches = 
                                        match_etag(ETag, IfMatchHeader),
                                    % item 45
                                    case ETagMatches of true -> 
                                        % item 44
                                        % Not Modified
                                        error(304, S6)
                                    ; false ->
                                        % item 46
                                        S7 = set_last_modified(LastModified, S6),
                                        
                                        Ex = exchange(S7),
                                        {Response, S8} = call(emx:get_resp_content_fun(Ex), S7),
                                        Ex1 = emx:set_resp_body(Response, Ex),
                                        S9 = set_exchange(Ex1, S8),
                                        % item 187
                                        finalize(S9)
                                    end
                                end
                            ; false ->
                                % item 46
                                S7 = set_last_modified(LastModified, S6),
                                
                                Ex = exchange(S7),
                                {Response, S8} = call(emx:get_resp_content_fun(Ex), S7),
                                Ex1 = emx:set_resp_body(Response, Ex),
                                S9 = set_exchange(Ex1, S8),
                                % item 187
                                finalize(S9)
                            end
                        end
                    end
                end
            ; false ->
                % item 291
                ETagMatches = 
                    match_etag(ETag, IfMatchHeader),
                % item 29
                case ETagMatches of true -> 
                    % item 290
                    {LastModified, S3} = call(last_modified, S2),
                    % item 302
                    case LastModified =:= undefined of true -> 
                        % item 284
                        {Expires, S4} = call(expires, S3),
                        S5 = set_etag(ETag, S4),
                        S6 = set_expires(Expires, S5),
                        % item 304
                        IfNoneMatch = 
                            elli_request:get_header(<<"If-None-Match">>, Req),
                        % item 36
                        case IfNoneMatch =:= undefined of true -> 
                            % item 39
                            case IfNoneMatch =:= <<"*">> of true -> 
                                % item 44
                                % Not Modified
                                error(304, S6)
                            ; false ->
                                % item 298
                                ETagMatches = 
                                    match_etag(ETag, IfMatchHeader),
                                % item 45
                                case ETagMatches of true -> 
                                    % item 44
                                    % Not Modified
                                    error(304, S6)
                                ; false ->
                                    % item 46
                                    S7 = set_last_modified(LastModified, S6),
                                    
                                    Ex = exchange(S7),
                                    {Response, S8} = call(emx:get_resp_content_fun(Ex), S7),
                                    Ex1 = emx:set_resp_body(Response, Ex),
                                    S9 = set_exchange(Ex1, S8),
                                    % item 187
                                    finalize(S9)
                                end
                            end
                        ; false ->
                            % item 46
                            S7 = set_last_modified(LastModified, S6),
                            
                            Ex = exchange(S7),
                            {Response, S8} = call(emx:get_resp_content_fun(Ex), S7),
                            Ex1 = emx:set_resp_body(Response, Ex),
                            S9 = set_exchange(Ex1, S8),
                            % item 187
                            finalize(S9)
                        end
                    ; false ->
                        % item 289
                        IfModifiedSince =
                            elli_request:get_header(<<"If-Modified-Since">>, Req),
                        % item 33
                        case IfModifiedSince =:= undefined of true -> 
                            % item 284
                            {Expires, S4} = call(expires, S3),
                            S5 = set_etag(ETag, S4),
                            S6 = set_expires(Expires, S5),
                            % item 304
                            IfNoneMatch = 
                                elli_request:get_header(<<"If-None-Match">>, Req),
                            % item 36
                            case IfNoneMatch =:= undefined of true -> 
                                % item 39
                                case IfNoneMatch =:= <<"*">> of true -> 
                                    % item 44
                                    % Not Modified
                                    error(304, S6)
                                ; false ->
                                    % item 298
                                    ETagMatches = 
                                        match_etag(ETag, IfMatchHeader),
                                    % item 45
                                    case ETagMatches of true -> 
                                        % item 44
                                        % Not Modified
                                        error(304, S6)
                                    ; false ->
                                        % item 46
                                        S7 = set_last_modified(LastModified, S6),
                                        
                                        Ex = exchange(S7),
                                        {Response, S8} = call(emx:get_resp_content_fun(Ex), S7),
                                        Ex1 = emx:set_resp_body(Response, Ex),
                                        S9 = set_exchange(Ex1, S8),
                                        % item 187
                                        finalize(S9)
                                    end
                                end
                            ; false ->
                                % item 46
                                S7 = set_last_modified(LastModified, S6),
                                
                                Ex = exchange(S7),
                                {Response, S8} = call(emx:get_resp_content_fun(Ex), S7),
                                Ex1 = emx:set_resp_body(Response, Ex),
                                S9 = set_exchange(Ex1, S8),
                                % item 187
                                finalize(S9)
                            end
                        ; false ->
                            % item 57
                            case LastModified > IfModifiedSince of true -> 
                                % item 371
                                % Precondition Failed
                                error(412, S3)
                            ; false ->
                                % item 284
                                {Expires, S4} = call(expires, S3),
                                S5 = set_etag(ETag, S4),
                                S6 = set_expires(Expires, S5),
                                % item 304
                                IfNoneMatch = 
                                    elli_request:get_header(<<"If-None-Match">>, Req),
                                % item 36
                                case IfNoneMatch =:= undefined of true -> 
                                    % item 39
                                    case IfNoneMatch =:= <<"*">> of true -> 
                                        % item 44
                                        % Not Modified
                                        error(304, S6)
                                    ; false ->
                                        % item 298
                                        ETagMatches = 
                                            match_etag(ETag, IfMatchHeader),
                                        % item 45
                                        case ETagMatches of true -> 
                                            % item 44
                                            % Not Modified
                                            error(304, S6)
                                        ; false ->
                                            % item 46
                                            S7 = set_last_modified(LastModified, S6),
                                            
                                            Ex = exchange(S7),
                                            {Response, S8} = call(emx:get_resp_content_fun(Ex), S7),
                                            Ex1 = emx:set_resp_body(Response, Ex),
                                            S9 = set_exchange(Ex1, S8),
                                            % item 187
                                            finalize(S9)
                                        end
                                    end
                                ; false ->
                                    % item 46
                                    S7 = set_last_modified(LastModified, S6),
                                    
                                    Ex = exchange(S7),
                                    {Response, S8} = call(emx:get_resp_content_fun(Ex), S7),
                                    Ex1 = emx:set_resp_body(Response, Ex),
                                    S9 = set_exchange(Ex1, S8),
                                    % item 187
                                    finalize(S9)
                                end
                            end
                        end
                    end
                ; false ->
                    % item 32
                    % Precondition Failed
                    error(412, S2)
                end
            end
        end
    ; false ->
        % item 286
        {PreviouslyExisted, S2} =
            call(previously_existed, S1),
        % item 9
        case PreviouslyExisted of true -> 
            % item 287
            {MovedPermanently, S3} = 
                call(moved_permanently, S2),
            % item 58
            case MovedPermanently of true -> 
                % item 61
                % Moved Permanently
                error(301, S3)
            ; false ->
                % item 288
                {MovedTemporarily, S4} =
                    call(moved_temporarily, S3),
                % item 62
                case MovedTemporarily of true -> 
                    % item 65
                    % Moved Temporarily
                    error(307, S4)
                ; false ->
                    % item 66
                    % Gone
                    error(410, S4)
                end
            end
        ; false ->
            % item 12
            % Not Found
            error(404, S2)
        end
    end
.

get_header(Name, State, Default) ->
    % item 658
    case elli_request:get_header(Name, request(State)) of
        undefined -> Default;
        Hdr -> Hdr
    end
.

handle_request(State) ->
    % item 596
    {Code, EndDoRequestState} = try do_request(State) of
        {_Code, _S1}=R -> R
    catch
        throw:{{halt, C}, S1} -> {C, S1}
    end,
    % item 598
    CodeState = set_response_code(Code, EndDoRequestState),
    % item 597
    call(finish_request, CodeState)
.

has_resp_body(State) ->
    % item 652
    emx:has_resp_body(exchange(State))
.

options_flow(State) ->
    % item 387
    {Hdrs, S1} = call(options, State),
    Exc = exchange(State),
    Exc1 = emx:set_resp_headers(Hdrs, Exc),
    S2 = set_exchange(Exc1, S1),
    % item 401
    % Ok
    respond(200, S2)
.

post_flow(State) ->
    % item 294
    Req = request(State),
    % item 389
    {ValidContentHeaders, S1} = 
        call(valid_content_headers, State),
    % item 392
    case ValidContentHeaders of true -> 
        % item 390
        {KnownContentType, S2} =
            call(known_content_type, S1),
        % item 394
        case KnownContentType of true -> 
            % item 391
            {ValidEntityLength, S3} =
                call(valid_entity_length, S2),
            % item 396
            case ValidEntityLength of true -> 
                % item 388
                {ResourceExists, S4} = 
                    call(resource_exists, S3),
                % item 72
                case ResourceExists of true -> 
                    % item 306
                    {LastModified, S5} = call(last_modified, S4),
                    % item 307
                    case LastModified =:= undefined of true -> 
                        % item 295
                        IfModifiedSince =
                            elli_request:get_header(<<"If-Modified-Since">>, Req),
                        % item 75
                        case IfModifiedSince =:= undefined of true -> 
                            % item 312
                            {SelectedContentType, S6} = 
                                select_content_type(S5),
                            % item 81
                            case SelectedContentType =:= none of true -> 
                                % item 112
                                % Unsupported MediaType
                                respond(415, S6)
                            ; false ->
                                % item 315
                                {_, ProcessFun} = SelectedContentType,
                                {ProcessResult, S7} = call(ProcessFun, S6),
                                S8 = encode_body_if_set(S7),
                                % item 325
                                case ProcessResult =:= true of true -> 
                                    % item 324
                                    finalize(S8)
                                ; false ->
                                    % item 323
                                    {redirect, Url} = ProcessResult,
                                    S8 = set_header_if_not_set(<<"Location">>, Url, S7),
                                    % item 100
                                    % See Other
                                    respond(303, S8)
                                end
                            end
                        ; false ->
                            % item 181
                            case LastModified > IfModifiedSince of true -> 
                                % item 312
                                {SelectedContentType, S6} = 
                                    select_content_type(S5),
                                % item 81
                                case SelectedContentType =:= none of true -> 
                                    % item 112
                                    % Unsupported MediaType
                                    respond(415, S6)
                                ; false ->
                                    % item 315
                                    {_, ProcessFun} = SelectedContentType,
                                    {ProcessResult, S7} = call(ProcessFun, S6),
                                    S8 = encode_body_if_set(S7),
                                    % item 325
                                    case ProcessResult =:= true of true -> 
                                        % item 324
                                        finalize(S8)
                                    ; false ->
                                        % item 323
                                        {redirect, Url} = ProcessResult,
                                        S8 = set_header_if_not_set(<<"Location">>, Url, S7),
                                        % item 100
                                        % See Other
                                        respond(303, S8)
                                    end
                                end
                            ; false ->
                                % item 184
                                % generate_etag/2,
                                % item 185
                                % expires/2,
                                % item 186
                                % Not Modified
                                respond(304, S5)
                            end
                        end
                    ; false ->
                        % item 312
                        {SelectedContentType, S6} = 
                            select_content_type(S5),
                        % item 81
                        case SelectedContentType =:= none of true -> 
                            % item 112
                            % Unsupported MediaType
                            respond(415, S6)
                        ; false ->
                            % item 315
                            {_, ProcessFun} = SelectedContentType,
                            {ProcessResult, S7} = call(ProcessFun, S6),
                            S8 = encode_body_if_set(S7),
                            % item 325
                            case ProcessResult =:= true of true -> 
                                % item 324
                                finalize(S8)
                            ; false ->
                                % item 323
                                {redirect, Url} = ProcessResult,
                                S8 = set_header_if_not_set(<<"Location">>, Url, S7),
                                % item 100
                                % See Other
                                respond(303, S8)
                            end
                        end
                    end
                ; false ->
                    % item 309
                    {PreviouslyExisted, S5} =
                        call(previously_existed, S4),
                    % item 104
                    case PreviouslyExisted of true -> 
                        % item 310
                        {MovedPermanently, S6} = 
                            call(moved_permanently, S5),
                        % item 113
                        case MovedPermanently of true -> 
                            % item 120
                            % Moved Permanently
                            respond(301, S6)
                        ; false ->
                            % item 311
                            {MovedTemporarily, S7} = 
                                call(moved_temporarily, S6),
                            % item 121
                            case MovedTemporarily of true -> 
                                % item 124
                                % Moved Temporarily
                                respond(307, S7)
                            ; false ->
                                % item 125
                                % Gone
                                respond(410, S7)
                            end
                        end
                    ; false ->
                        % item 313
                        {AllowMissingPost, S6} = 
                            call(allow_missing_post, S5),
                        % item 117
                        case AllowMissingPost of true -> 
                            % item 589
                            {SelectedContentType, S7} = 
                                select_content_type(S6),
                            % item 126
                            case SelectedContentType =:= none of true -> 
                                % item 590
                                {_, ProcessFun} = SelectedContentType,
                                {ProcessResult, S8} = call(ProcessFun, S7),
                                Location = get_resp_header(<<"Location">>, S8),
                                % item 134
                                case Location =/= undefined of true -> 
                                    % item 137
                                    % Created
                                    respond(201, S8)
                                ; false ->
                                    % item 180
                                    finalize(S8)
                                end
                            ; false ->
                                % item 338
                                % Unsupported MediaType
                                respond(415, S7)
                            end
                        ; false ->
                            % item 116
                            % Not Found
                            respond(404, S6)
                        end
                    end
                end
            ; false ->
                % item 398
                % Request Entity Too Large
                respond(413, S3)
            end
        ; false ->
            % item 399
            % Unsupported Media Type
            respond(415, S2)
        end
    ; false ->
        % item 400
        % Not Implemented
        respond(501, S1)
    end
.

put_flow(State) ->
    % item 386
    State
.

request(State) ->
    % item 646
    Exchange = State#machine_flow_state.exchange,
    Exchange#machine_exchange.req
.

respond(Code, State) ->
    % item 670
    {Code, State}
.

select_content_type(State) ->
    % item 628
    ContentTypeHeader = get_header(<<"Content-Type">>, State, <<"application/octet-stream">>),
    {ContentTypesAccepted, S1} = call(content_types_accepted, State),
    SelectedContentType = elli_machine_util:select_content_type(ContentTypesAccepted, ContentTypeHeader),
    {SelectedContentType, S1}
.

set_allowed_methods(AllowedMethods, State) ->
    % item 679
    BinMethods = [ erlang:atom_to_binary(M, latin1) || M <- AllowedMethods], 
    HeaderValues = elli_machine_util:binary_join(BinMethods, <<", ">>),
    set_resp_header(<<"Allow">>, HeaderValues, State)
.

set_exchange(Exchange, State) ->
    % item 634
    State#machine_flow_state{exchange=Exchange}
.

set_response_code(Code, State) ->
    % item 640
    Ex = emx:set_resp_code(Code, exchange(State)),
    set_exchange(Ex, State)
.

with_exchange(Fun, State) ->
    % item 622
    Exchange = Fun(State#machine_flow_state.exchange),
    State#machine_flow_state{exchange=Exchange}
.

%%
%% Helpers
%%

% @doc Add a variance if needed.
add_variance([], _, Variances) ->
    Variances;
add_variance([_], _, Variances) ->
    Variances;
add_variance(_, Name, Variances) ->
    [Name | Variances].


% @doc Set the response's chosen charset
set_resp_chosen_charset(Charset, State) ->
    Ex = emx:set_resp_chosen_charset(Charset, exchange(State)),
    set_exchange(Ex, State).
    

set_etag(_Tag, State) ->
    State.

set_expires(_Expires, State) ->
    State.

set_last_modified(_LastModified, State) ->
    State.

set_resp_header(Header, Value, #machine_flow_state{exchange=Ex}=S) ->
    Ex1 = emx:set_resp_header(Header, Value, Ex),
    S#machine_flow_state{exchange=Ex1}.

get_resp_header(_Header, State) ->
    {undefined, State}.

match_etag(_Tag, _TagList) ->
    false.

encode_body_if_set(State) ->
    State.

set_header_if_not_set(_Header, _Value, State) ->
    State.
